version: '3.9'

services:
  mqtt:
    image: eclipse-mosquitto:2
    restart: unless-stopped
    ports:
      - '1883:1883'
    volumes:
      - ./deploy/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    env_file:
      - ./apps/api/.env.example
    environment:
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883
      - API_PORT=3000
    depends_on:
      - mqtt
    ports:
      - '3000:3000'

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        VITE_API_URL: /api
        VITE_WS_URL: /
    environment:
      - VITE_API_URL=/api
      - VITE_WS_URL=/
    command: ['npm', 'run', 'preview', '--workspace', 'apps/web', '--', '--host', '0.0.0.0', '--port', '4173']
    depends_on:
      - api
    ports:
      - '4173:4173'

  proxy:
    image: nginx:1.27-alpine
    depends_on:
      - web
      - api
    ports:
      - '8080:80'
    volumes:
      - ./deploy/nginx.conf:/etc/nginx/nginx.conf:ro
    restart: unless-stopped
